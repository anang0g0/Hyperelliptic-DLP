N = 256
@le_u = [N, N, N, N]
@le_v = [N, N, N, N]
@uu = [N, N, N, N]
@vv = [N, N, N, N]
@U = [N, N, N, N]
@V = [N, N, N, N]

# /* definition of a curve */
def HEC()

  #find by Harley
  @q = 10 ** 19 + 51
  @a = [3141592653589793238, 4626433832795028841, 9716939937510582097, 4944592307816406286, 2089986280348253421]
  #@u1_=[13131182302866750318,6953593084278582387]
  #@v1_=[@q,0] #infinity
  @uh = [8940387226809150403, 3838225076702837943]
  @vh = [8035450087728851271, 1893861348804881148]
  # ff=x^5+314159265358979338*x^4+4626433832795028841*x^3+9716939937510582097*x^2+4944592307816406286*x+2089986280348253421
  @u1 = [10027301878627002813, 9681764174062850433]
  #616419646419685014=a*3542790122851877922+b
  #0=a*6484511755775124891+b
  #616419646419685014=a*7058278367076753082
  @v1 = [9406915506559133975, 920961725690419616]
  @u2 = [15109848135481867673, 5563304430399854240]
  #2935061693073737419=a*5239897978117534135+b
  #3524464046627319761=a*9869950157364333538+b
  #589402353553582342=a*4630052179246799403
  @v2 = [7250939689363649434, 6461431514924022130]
  @J = 99999999982871020671452277000281660080
  #? 7054215880371151972602291562049
  s1 = 1712898036
  s2 = 11452277089352355350

  @b = [1597, 1041, 5503, 6101, 1887]
  @u = [1571353025997967, 12198441063534328]
  @v = [32227723250469108, 67133247565452990]
  @u0 = [70887725815800572, 94321182398888258]
  @v0 = [42016761890161508, 3182371156137467]

  #find by Lange
  # f=xx^5+153834295433461683634059*xx^3+1503542947764347319629935*xx^2+1930714025804554453580068*xx+790992824799875905266969
  @p3 = 1932005208863265003490787
  @F1 = [0, 153834295433461683634059, 1503542947764347319629935, 1930714025804554453580068, 790992824799875905266969]
  @uu0 = [1594018975878036024296315, 52552598504459997856285]
  @uu1 = [1791061143796384566472590, 160038959612724914387201]
  #504894935863953268767725=a*106028591185649525291891+b
  #704210062398295465154981=a*1487990384692386499004424+b
  @vv0 = [1288294670775269897135356, 942599769284250370891960]
  #1=a*704665787761008893641614+b
  #824513992484349685277891=a*1086395356035375672830976+b
  @vv1 = [325694573428709528176000, 1410279347067078324080410]
  @p4 = 3713820117856140824697372689
  # ff=x^5+241216435998068557682742515*x^3+553011586465186980114036462*x^2+1456621446251091989731057514*x+3440013483680364963850133535
  @F0 = [0, 241216435998068557682742515, 553011586465186980114036462, 1456621446251091989731057514, 3440013483680364963850133535]
  @uua = [3090907731099435637713212933, 3430279740253146837327450789]
  #1090190095529845640563737560=a*901573235033529767913345809+b
  #1607209110223949051233778495=a*2189334496065905869799867124+b
  @vva = [1516936926385660062377077660, 177161035616247877668423903]
  #1044171804289905858226438503=a*10486172923382208811538764+b
  #928996521279782754969642877=a*1874123356916514825274712274+b
  #3598644834846017721440577063=a*1863637183993132616463173510
  @uub = [1884609529839897034086251038, 265492627929763696542013047]
  @vvb = [515973747200726989346030903, 2866067948417124660466300132]

  #find by Gaudry
  #fg=x^5+2682810822839355644900736*x^3+226591355295993102902116*x^2+2547674715952929717899918*x+4797309959708489673059350
  @P = 5 * 10 ** 24 + 8503491
  @FF = [0, 2682810822839355644900736, 226591355295993102902116, 2547674715952929717899918, 4797309959708489673059350]
  @Jga = 24999999999994130438600999402209463966197516075699
  #@Jgb=25000000000005869731468829402229428962794965968171
  #50724386855111482309402*2779199501981512279739817%P
  #2055622596816515886446193*1553122609714208136553134%P
  #1520505942073936921231867
  @ug0 = [1, -1713538969626908355896596]
  @vg0 = [0, 138905579055173741542118]
  @ug1 = [1738366273424896804842766, 3184841659043138633535652]
  @vg1 = [2931056213155642836850986, 402980510097415333052905]

  
end

# invert of integer
def inv(a, n)
  d = n
  x = 0
  s = 1
  while (a != 0)
    q = d / a
    r = d % a
    d = a
    a = r
    t = x - q * s
    x = s
    s = t
  end
  gcd = d  # $\gcd(a, n)$

  return ((x + n) % (n / d))
end


def j2add(u11,u10,u21,u20,v11,v10,v21,v20,h2,h1,h0,f4,f3,f2,f1,f0,p)
  z1=(u11-u21)%p; z2=(u20-u10)%p; z3=(u11*z1+z2)%p;
  r=(z2*z3+(z1**2)*u10)%p
  
  inv1=z1; inv0=z2;
  w1=(v10-v20)%p; w2=(v11-v21)%p; w3=inv0*w1%p; w4=inv1*w2%p;
  s1_=((inv0+inv1)*(w1+w2)-w3-w4*(1+u11))%p; s0_=(w3-u10*w4)%p;
  
  
  w1=inv(r*s1_,p)
  w2=r*w1%p
  w3=(s1_**2)*w1%p
  w4=r*w2%p
  w5=(w4**2)%p
  s0__=s0_*w2%p
  
  l2_=(u21+s0__)%p
  l1_=(u21*s0__+u20)%p
  l0_=u20*s0__%p
  
  u0_=((s0__-u11)*(s0__-z1+h2*w4)-u10+l1_+(h1+2*v21)*w4+(2*u21-z1-f4)*w5)%p
  u1_=(2*s0__-z1-w5+h2*w4)%p
  @U=[u1_,u0_]
  
  w1=(l2_-u1_)%p
  w2=(u1_*w1+u0_-l1_)%p
  v1_=(w2*w3-v21-h1+h2*u1_)%p
  w2=(u0_*w1-l0_)%p
  v0_=(w2*w3-v20-h0+h2*u0_)%p
  @V=[v1_,v0_]
  print "diva (s^2+",u1_,"*s+",u0_,",",v1_,"*s+",v0_,")\n"
  
  end
  
  
  def g2ads(u11,u10,u21,u20,v11,v10,v21,v20,h2,h1,h0,f4,f3,f2,f1,f0,p)
  
  r=(u21-(u21*u10)*u10)%p
  
  inb=inv(r,@p3)
  
  s0=inb*(v10-v20-v21*u10)%p
  
  l1=s0*u21%p
  l0=s0*u20%p
  
  k2=(f4-u21)%p
  k1=(f3-(f4-u21)*u21-u20-v21*h2)%p
  
  u1_=(k2-s0**2-u10-s0*h2)%p
  u0_=(k1-s0*(l1+2*v21+h1)-u10*u1_)%p
  
  v1_=((h2+s0)*u1_-(h1+l1+v21))%p
  v0_=((h2+s0)*u0_-(h0+l0+v20))%p
  
  end
  
  
  def j2dbl(u1,u0,v1,v0,h2,h1,h0,f4,f3,f2,f1,f0,p)
  
  v1goal=(h1+2*v1-h2*u1)%p
  v0goal=(h0+2*v0-h2*u0)%p
  
  w0=v1**2%p
  w1=u1**2%p
  w2=v1goal**2%p
  w3=u1*v1goal%p
  r=(u0*w2+v0goal*(v0goal-w3))%p
  
  inv1_=-v1goal%p
  inv0_=(v0goal-w3)%p
  
  w3=(f3+w1)%p
  w4=2*u0%p
  k1_=(2*(w1-f4*u1)+w3-w4-v1*h2)%p
  k0_=(u1*(2*w4-w3+f4*u1+v1*h2)+f2-w0-2*f4*u0-v1*h1-v0*h2)%p
  
  w0=k0_*inv0_%p
  w1=k1_*inv1_%p
  s1_=((inv0_+inv1_)*(k0_+k1_)-w0-w1*(1+u1))%p
  s0_=(w0-u0*w1)%p
  
  
  w1=inv(r*s1_,p)
  w2=r*w1%p
  w3=s1_**2*w1%p
  w4=r*w2%p
  w5=w4**2%p
  s0__=s0_*w2%p
  
  l2_=(u1+s0__)%p
  l1_=(u1*s0__+u0)%p
  l0_=u0*s0__%p
  
  u0_=(s0__**2+w4*(2*v1+h1+h2*(s0__+u1))+w5*(2*u1-f4))%p
  u1_=(2*s0__-w5+w4*h2)%p
  @uu=[u1_,u0_]
  
  w1=(l2_-u1_)%p
  w2=(u1_*w1+u0_-l1_)%p
  v1_=(w2*w3-v1-h1-u1_*h2)%p
  w2=(u0_*w1-l0_)%p
  v0_=(w2*w3-v0-h0)%p
  @vv=[v1_,v0_]
  print "div (s^2+",u1_,"*s+",u0_,",",v1_,"*s+",v0_,")\n"
  
  end
  
  
  def chao(u11,u10,v11,v10,f4,f3,f2,p)
  
  w1=v11**2%p
  w2=u11*v11%p
  r=(u10*w1+v10*(v10-w2))%p
  
  if r==0
   print "r=0\n"
   u11=(v10*inv(v11,p)-u11)%p
   v11=-v10*inv(v11,p)%p
   w1=v11**2%p
   w2=u11*v11%p
   r=(u10*w1+v10*(v10-w2))%p
  end
  
  w3=inv(2*r,p)
  i11=-v11*w3%p
  i10=(v10-w2)*w3%p
  #print "I=",i11,"x+",i10,"\n"
  
  w2=(u11-f4)%p; w3=2*u10%p;
  t10=(u11*(2*w3-u11*w2-f3)-f4*w3+f2-w1)%p;
  t11=(u11*(2*w2+u11)+f3-w3)%p;
  
  w1=i10*t10%p; w2=i11*t11%p;
  w3=((i10+i11)*(t10+t11)-w1-w2)%p;
  s1=(w3-u11*w2)%p
  s0=(-u10*w2+w1)%p
  
  if s1==0
   print "s1=0\n"
   exit();
  end
  
  w1=inv(s1,p)
  u20=(w1*(w1*(s0**2+2*u11*-f4)+2*v11))%p;
  u21=w1*(2*s0-w1)%p; u22=1;
  @uu=[u21,u20]
  print "factormod(s^2+",u21,"*s+",u20,",",p,")\n"
  
  w1=(u11-u21)%p
  v20=(u20*(s1*w1+s0)-s0*u10-v10)%p;
  v21=(s1*(u21*w1+u20-u10)-s0*w1-v11)%p;
  @vv=[v21,v20]
  print "v'=",v21,"s",v20,"\n";
  
  if(v20==0 || v21==0)
   print "infinity!\n"
   exit()
  end
  
  end
  
  
  
  def kotehan(u21,u20,u11,u10,v21,v20,v11,v10,f4,p)
  
  w1=(u21-u11)%p; w2=(u21*w1+u10-u20)%p;
  r=(u10*(w2-u20)+u20*(u20-u11*w1))%p
  if r==0
   print "r=0!\n"
   exit();
  end
  
  w3=inv(r,p); i11=w1*w3%p; i10=w2*w3%p;
  
  w3=(v20-v10)%p; w4=(v21-v11)%p;
  w5=i10*w3%p; w6=i11*w4%p;
  w7=((i10+i11)*(w3+w4)-w5-w6)%p;
  s1=(w7-u21*w6)%p; s0=(-u20*w6+w5)%p;
  
  if s1==0
   print "s1=0!\n"
   exit();
  end
  
  w3=inv(s1,p)
  u30=(w3*(w3*(s0**2+u11+u21-f4)+2*(v11-s0*w1))+w2)%p;
  u31=(w3*(2*s0-w3)-w1)%p; u32=1;
  
  w1=(u30-u10)%p; w2=(u11-u31)%p;
  v30=(s1*u30*w2+s0*w1-v10)%p;
  v31=(s1*(u31*w2+w1)-s0*w2-v11)%p;
  @U=[u31,u30]
  @V=[v31,v30]
  print "divk (s^2+",u31,"*s+",u30,",",v31,"*s+",v30,")\n"
  
  end
  

def g2add(u11, u10, v11, v10, u21, u20, v21, v20, f4, f3, f2, f1, f0, p)
  a0 = (u11 * u10)%p; a1 = (u21 * u20)%p; d0 = (u10 - u20)%p; d1 = (u11 - u21)%p;
  b0 = (u11 * u11)%p; b1 = (u21 * u21)%p; c0 = (v20 - v10)%p; c1 = (v21 - v11)%p;
  e0 = (-u20 + u10)%p; s1 = (a1 - a0)%p; s2 = (b1 - b0)%p; s3 = (s2 + e0)%p;
  iv = inv(d0 * s3 - d1 * s1, p)
  ss2 = (u20 + u11 * u21 + u10)%p; ss3 = (u21 + u11)%p;
  l3 = inv(d0 * c1 - d1 * c0, p); l2 = inv(c0 * s3 - c1 * s1, p)
  l1 = (u11 * l2 + v11 + (b0 - u10) * l3)%p;
  u31 = (2 * l2 * l3 + 1 - ss3)%p;
  u30 = (2 * l1 * l3 + l2 * l2 + 1 - f4 - u31 * ss3 - ss2)%p;
  ul0 = (u30 * l3; ul = -u31 * l2 + l1)%p;
  v31 = -(u31 * u31 - ul0 + ul)%p; v30 = -(u31 * ul0 + ul)%p;

  @U=[u31,u30]
  @V=[v31,v30]

  #  return u31, u30, v31, v30
end

def g2dbl(u1, u0, v1, v0, f3, f2, f1, f0, p)
  uu1 = (u1 * u1)%p; uu0 = (u1 * u0)%p; uv01 = (u0 * v1)%p; uv10 = (u1 * v0)%p; uv11 = (u1 * v1)%p;
  uv00 = (u0 * v0)%p;
  d0 = (6 * v1 * uu1 - uv10)%p; d1 = (-4 * uv11 + 4 * v0)%p; d2 = (2 * v1)%p;
  d3 = (6 * v1 * uu0 - 6 * uv00)%p; d4 = (-4 * uv01)%p; d5 = (2 * v0)%p;
  e0 = (5 * (-u1 * uu1 + 2 * uu0) - 3 * f3 * u1 + 2 * f2)%p;
  e1 = (5 * (-u0 * uu0 + u0 * u0) - 3 * f3 * u0 + f1)%p;
  m0 = (d3 - d5 * (uu1 - u0))%p; m1 = (d4 - d5 * (-u1))%p;
  m3 = (d0 - d2 * (uu1 - u0))%p; m4 = (d1 - d2 * (-u1))%p;
  s1 = (e1 - d5 * v1)%p; s2 = (e0 - d2 * v1)%p;
  iv = inv(m0 * m4 - m1 * m3, p)
  l3 = inv(m4 * s1 - m1 * s2, p); l2 = inv(m0 * s2 - m3 * s1, p)
  l1 = (v1 + u1 * l2 - (uu1 - u0) * l3)%p; l0 = (v0 + u0 * l2 - (uu0) * l3)%p;
  ue1 = (2 * l3 * l2 - 2 * u1 - 1)%p;
  ue0 = (2 * l3 * l1 + l2 * l2 - 2 * u0 - uu0 - 2 * ue1 * u1)%p;
  uue1 = (ue1 * ue1)%p; uue0 = (ue1 * ue0)%p;
  ve1 = ((uu1 - ue0) * l3 - ue1 * l2 + l1)%p;
  ve0 = (uue0 * l3 - ue0 * l2 + l0)%p;

  @uu=[ue1,ue0]
  @vv=[ve1,ve0]

#  return ue1, ue0, ve1, ve0
end

def mktable(u, v)
  # print @q ,"\n"
  pp = 31
  print pp, "\n"
  @uu = u
  print @uu, "\n"
  @vv = v
  print @vv, "\n"
  a = [1, 1, 1, 1, 1]
  # print  a ,"\n"
  # print  @CRV_b ,"\n"

  # enzan table
  @le_u[0] = @uu
  @le_v[0] = @vv
  print @uu, " l673\n"
  print @vv, " l674\n"

  for i in 1..N - 1 #begin Pub_key at plain
    g2dbl(@uu[0], @uu[1], @vv[0], @vv[1], @FF[0], @FF[1], @FF[2], @FF[3], @q)
    @le_u[i] = @uu
    @le_v[i] = @vv
    #print i,"=",@le_u[i],"\n"

    #   @uu=@le_u[i]
    #   @vv=@le_v[i]
  end #of for
  print i, "i\n"
end

#D'=mD
def jac(kk, p)
  j = 0
  ki = [N]

  for j in 0..N
    ki[j] = 0
  end
  j = 0
  for i in 0..N
    if (((kk ^ (1 << i)) >> i) % 2 == 0) #testbit(kk,i)
      ki[j] = i
      j = j + 1
      print i, "L704\n"
    end
  end

  @U = @le_u[ki[0]]
  @V = @le_v[ki[0]]

  #print @le_u[ki[0]],"\n"
  #print @le_u[ki[2]],"\n"
  #exit();
  for i in 1..j - 1
    if (@U != @le_u[ki[i]])
      g2add(@U[0], @U[1], @le_u[ki[i]][0], @le_u[ki[i]][1], @V[0], @V[1], @le_v[ki[i]][0], @le_v[ki[i]][1], @FF[0], @FF[1], @FF[2], @FF[3], @FF[4], p)
      #print "i=",i," ",@le_u[ki[i]][0],"\n"
    end

    if (@U == @le_u[ki[i]])
      print @le_u[ki[i]], "=", @U, "\n"
      print i, "de('A`)\n"
      exit()
    end
  end #of for
end


#jj=aa^bb mod oo
def exp(aa, bb, oo)
kk=[8192];
c=[8192]


ii=oo;
  j=0;
  jj=0;
  count=0;

  for i in 0..8192-1
    kk[i]=0;
end
  while(ii>0)
    ii = (ii>>1);
    j=j+1;
  end


  kk[0]=aa;

#  cout << j << "\n";
  
#ex.1000=2**3+2**5+2**6+2**7+2**8+2**9 makes a array c=[3,5,6,7,8,9]
  for i in 0..j
    if(((bb^(1<<i))>>i)%2 == 0) #testbit(kk,i)
        c[count]=i
        count=count+1
       #print i,"L704\n" 
      end
    end
 
#    cout << bb << endl;
#    cout << count << "\n";
#exit(1);
    for i in 1..c[count-1]
      kk[i] = kk[i-1]*kk[i-1]%oo;
    end

    jj=1;
    for i in 0..count-1
      jj=kk[c[i]]*jj%oo;
      if (jj==0)
#	print i,"\n"
      end
    end

    return jj;
end


def root(a, p)
print "p mod =",p%4,",",p%8 ,"\n"
  if(p%4==3 || p%8==5)
  
  if(p%4==3)
    b=(p+1)/4;
    c=exp(a,b,p);
  if(c*c%p!=a)
    print "baka1\n"
    #exit()
  end 
  if(c*c%p==a)
    print "good\n"
    print "c=",c,"\n"
  end
  end
  if(p%8==5)
    c=exp(a,(p+3)/8,p)
    if(c*c%p!=a)
      print "baka\n"
    end
    if(c*c%p==a)
      print "good\n"
      print c,"\n"
    end
  end
  if(p%8==5)
    c=2*a*exp(4*a,(p-5)/8,p)
    if(c*c%p!=a)
      print "dangerous\n"
    end
    if(c*c%p==a)
      print "good\n"
      print c, "\n"
    end
  end
  #print a ,"\n";
  #print c*c%p , "\n";

  return c;
end

return 0
end


def tr1e(x,f4,f3,f2,f1,f0,p)
  
  b=x**5+f4*x**4+f3*x**3+f2*x*x+f1*x+f0
  c=root(b%p,p)
  if(c==0)
    return 0;
  end
  a=c*c
  if(a%p==b%p)
    print x,",",c,"\n"    
    return c
  end
  return -1
end

=begin
p127=(2**63-27443)*2**64+1
r=28948022309328876595115567994214488524823328209723866335483563634241778912751
f0=17
srand(12345)
count=0
while(count<3)
l= -1
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,0,0,0,0,f0,p127)
if(l==0)
  break
end
end
print "c=",l,"\n"
count=count+1
end
print p127,"\n"
print "------------------------\n"

p128=2**128-24935
f00=3**7
r1=115792089237316195401210495125503591471546519982099914586091636775415022457661
count=0
while(count<3)
l= -1
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,0,0,0,0,f00,p128)
if(l==0)
  break
end
end
print "c=",l,"\n"
count=count+1
end
print p128,"\n"
print "------------------------\n"
exit()
=end

p2=2**128-173
r2 = 115792089237316195429342203801033554170931615651881657307308068079702089951781
f23 = 318258242717201709453901384328569236653
f22 = 75380722035796344355219475510170298006
f21 = 129416082603460579272847694630998099237 
f20 = 143864072772599444046778416709082679388


count=0
while(count<3)
l= -1
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,0,f23,f22,f21,f20,p2)
if(l==0)
  break
end
end
print "c=",l,"\n"
count=count+1
end
print p2,"\n"
print "------------------------\n"

p1=2**127-1
r1=28948022309329048848169239995659025138451177973091551374101475732892580332259
f13 = 34744234758245218589390329770704207149
f12 = 132713617209345335075125059444256188021
f11 = 90907655901711006083734360528442376758
f10 = 6667986622173728337823560857179992816

count=0
while(count<3)
l= -1
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,0,f13,f12,f11,f10,p1)
if(l==0)
  break
end
end
print "c=",l,"\n"
count=count+1
end
print p1,"\n"
print "------------------------\n"
exit()

count=0
while(count<3)
l= -1
q = 10 ** 19 + 51
a = [3141592653589793238, 4626433832795028841, 9716939937510582097, 4944592307816406286, 2089986280348253421]
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,a[0],a[1],a[2],a[3],a[4],q)
if(l==0)
  break
end
end
count=count+1
print "c=",l,"\n"
end
print "------------------------\n"

count=0
while(count<3)
l= -1
p3 = 1932005208863265003490787
gg = [0, 153834295433461683634059, 1503542947764347319629935, 1930714025804554453580068, 790992824799875905266969]
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,gg[0],gg[1],gg[2],gg[3],gg[4],p3)
if(l==0)
  break
end
end
count=count+1
print "c=",l,"\n"
end
print "------------------------\n"

count=0
while(count<3)
l= -1
pp = 5 * 10 ** 24 + 8503491
ff = [0, 2682810822839355644900736, 226591355295993102902116, 2547674715952929717899918, 4797309959708489673059350]
while(l == -1)
  x=rand(0..10**10)
l=tr1e(x,ff[0],ff[1],ff[2],ff[3],ff[4],pp)
if(l==0)
  break
end
end
print "c=",l,"\n"
count=count+1
end

exit()

#HEC()
#root(f10,p1)
#root(@f20,@p2)
#Jx=0
#Jy=194748000917607189990017085266394730231
#root(@F1[4],@p3)
#root(f00,p127)
#root(f_0,p128)
exit()



mktable(@ug0, @vg0)
jac(@Jga, @P)
